
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Utility library for faster, easier, and more reliable data analysis">
      
      
        <link rel="canonical" href="https://eshinjolly.com/utilz/api/goodpipes/">
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.2">
    
    
      
        <title>Functional-programming-style data analysis - Utilz</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.19190aaf.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.24b84193.min.css">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../custom.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#efficient-functional-programming-style-data-analysis" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://eshinjolly.com/utilz" title="Utilz" class="md-header-nav__button md-logo" aria-label="Utilz">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Utilz
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Functional-programming-style data analysis
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/ejolly/utilz/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ejolly/utilz
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://eshinjolly.com/utilz" title="Utilz" class="md-nav__button md-logo" aria-label="Utilz">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Utilz
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/ejolly/utilz/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ejolly/utilz
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../io/" class="md-nav__link">
      Saving and Loading
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../verbs/" class="md-nav__link">
      Data analysis "verbs"
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Functional-programming-style data analysis
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Functional-programming-style data analysis
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#memoization" class="md-nav__link">
    Memoization
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#partial-function-application-currying" class="md-nav__link">
    Partial function application (currying)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cacheing-outputs-to-disk" class="md-nav__link">
    Cacheing outputs to disk
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../guards/" class="md-nav__link">
      Guards and Decorators
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ops/" class="md-nav__link">
      Operations
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../pipe/" class="md-nav__link">
      Pipe Operator
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../termplot/" class="md-nav__link">
      Terminal Plots
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../plot/" class="md-nav__link">
      Plotting Helpers
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#memoization" class="md-nav__link">
    Memoization
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#partial-function-application-currying" class="md-nav__link">
    Partial function application (currying)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cacheing-outputs-to-disk" class="md-nav__link">
    Cacheing outputs to disk
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ejolly/utilz/edit/master/docs/api/goodpipes.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="efficient-functional-programming-style-data-analysis">Efficient functional-programming-style data analysis</h1>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">utilz</span> <span class="kn">import</span> <span class="n">clear_cache</span><span class="p">,</span> <span class="n">disk_cache</span><span class="p">,</span> <span class="n">load</span>
<span class="kn">from</span> <span class="nn">toolz</span> <span class="kn">import</span> <span class="n">memoize</span><span class="p">,</span> <span class="n">curry</span><span class="p">,</span> <span class="n">pipe</span>
</code></pre></div>
<p>First clear any existing cache, i.e. the <code>.utilz_cache</code> folder.  </p>
<div class="highlight"><pre><span></span><code><span class="n">clear_cache</span><span class="p">()</span>
</code></pre></div>
<h2 id="memoization">Memoization</h2>
<p><strong>Memoize</strong> a function to save its last input in RAM and recall it when called with the same inputs rather than re-executing a potentially long running function</p>
<div class="highlight"><pre><span></span><code><span class="nd">@memoize</span>
<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="s2">&quot;Simulate loading a slow large dataset&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loading from disk&quot;</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div>
<h2 id="partial-function-application-currying">Partial function application (currying)</h2>
<p><strong>Curry</strong> so a function operates normally when it receives all its required arguments, but turns into a <em>partial</em> function when it gets fewer that all its required arguments. This partial function behaves just like the original except with a subset of its arguments fixed. This also allows any functions to work with <code>toolz.pipe()</code>, while still being able to manipulate a function's arguments. That's because <code>pipe()</code> implicitly passes the output of the last function as the input of the next. </p>
<div class="highlight"><pre><span></span><code><span class="nd">@curry</span>
<span class="k">def</span> <span class="nf">calc_mean</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="o">...</span>

<span class="c1"># With no kwargs you sometimes have to write the args backwards</span>
<span class="nd">@curry</span>
<span class="k">def</span> <span class="nf">calc_mean</span><span class="p">(</span><span class="n">norm_value</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="o">...</span>

<span class="c1"># Now this works, otherwise it would complain about the wrong number of arguments</span>
<span class="n">pipe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
    <span class="n">calc_mean</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<h2 id="cacheing-outputs-to-disk">Cacheing outputs to disk</h2>
<p><strong>Cache</strong> so the result of a function is stored to disk in file made unique by the args and kwargs to the function. Use <code>utilz.disk_cache</code> to decorate a function so it caches, which works just like <code>toolz.memoize</code> but stores the result to a file and loads the file when called with the same inputs. Better that <code>memoize</code> for larger memory hungry inputs and outputs, and necessary if input or outputs cannot be pickled (e.g. dataframes, arrays, deep objects, etc). Setting the threshold to something like 1 or 0 essentially always caches the result. </p>
<div class="highlight"><pre><span></span><code><span class="nd">@curry</span>
<span class="nd">@disk_cache</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">denom</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="s2">&quot;Simulate expensive normalization function that takes args&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;computing...&quot;</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;norm&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">denom</span><span class="p">]})</span>
</code></pre></div>
<h1 id="together">Together</h1>
<p>Because <code>load</code> is memoized by default, only the first run of this pipeline actually loads the data and incurs the i/o cost. </p>
<p>Because <code>norm</code> is decorated by <code>disk_cache</code>, only the first run with the same prior pipeline steps incurs a compute cost.</p>
<div class="highlight"><pre><span></span><code><span class="n">summary</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">(</span>
    <span class="s2">&quot;test.csv&quot;</span><span class="p">,</span>
    <span class="n">load</span><span class="p">,</span>
    <span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">),</span>
    <span class="n">assign</span><span class="p">(</span><span class="n">a_centered</span><span class="o">=</span><span class="s2">&quot;A - B.mean()&quot;</span><span class="p">,</span> <span class="n">mean_C</span><span class="o">=</span><span class="s2">&quot;mean(C)&quot;</span><span class="p">,</span> <span class="n">std_C</span><span class="o">=</span><span class="s2">&quot;std(C)&quot;</span><span class="p">),</span> 
    <span class="n">norm</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="n">denom</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Using the joblib.Memory module also does disk-cacheing, but </span>
<span class="c1"># for some reason doesn&#39;t seem to work with currying</span>
</code></pre></div>
<p>This setup is nice because it allows for <em>both</em> interactive data analysis as well as reproducible scripts. Simply start writing the pipeline steps, and comment out ones you want to skip or debug. In another notebook cell edit the source code of a function in the pipeline and incrementally add to its body, while rerunning the pipeline to see results as you build up your functions. </p>
<p>For functions that take a while to run, try wrapping them in <code>memoize</code> or <code>disk_cache</code>. Memoize is nice for loading csv/text files (so you don't need to re-read them from disk each re-run of the pipeline). Cacheing is nice for expensive operations or operations on complex datastructures like arrays and dataframes. Plus, <code>utilz</code> saves them in standard robust file types (<code>.csv</code>. or .<code>h5</code>) files so you're also getting incremental backups of your work. No more need to rely on saved "state" in a Juptyer notebook.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../verbs/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Data analysis "verbs"
              </div>
            </div>
          </a>
        
        
          <a href="../guards/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Guards and Decorators
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.7e0ee788.min.js"></script>
      <script src="../../assets/javascripts/bundle.c1ccee15.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>